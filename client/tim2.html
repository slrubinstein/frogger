<html>
<head>
<style>
#swatch {
  width: 40px;
  height: 40px;
}

#gameContainer canvas {
  position: absolute;
  left: 0;
}

</style>
</head>
<body>
  <script src="assets/js/color-thief.min.js"></script>
  <video autoplay="true" loop id="videoElement" src="assets/vid/test.mov" width="600"></video>
  <div id="gameContainer">
    <canvas width="600" id="canvas" height="375"></canvas>
    <canvas width="600" id="game" height="375"></canvas>
  </div>
  <img src="assets/img/frog.png" id="frog" width="50" style="display:none">
  <script>
    const video = document.getElementById('videoElement'),
        canvas = document.getElementById('canvas'),
        game = document.getElementById('game'),
        frog = document.getElementById('frog'),
        body = document.querySelector('body'),
        ctx = canvas.getContext('2d'),
        gctx = game.getContext('2d'),
        w = canvas.width, h = canvas.height,
        colorThief = new ColorThief();

    let frogX = w/2 - 25, frogY = h - 50;
    let color;
    let gameHasChanged = true;
    let tickNo = 0;

    document.onkeydown = (e) => {
      if (e.keyCode == '38') frogY-=2;
      else if (e.keyCode == '40') frogY+=2;
      else if (e.keyCode == '37') frogX-=2;
      else if (e.keyCode == '39') frogX+=2;
      gameHasChanged = true;
      e.preventDefault();
    };

    video.addEventListener('play', () => {
      init();
    }, false);

    init = () => {
      tick();
      // color = '#' + color[0].toString(16) + color[1].toString(16) + color[2].toString(16);
    }

    tick = () => {
      tickNo++;
      drawFrame();
      drawGame();
      if (detectCollision()) {
        body.style.backgroundColor = 'red';
      } else {
        body.style.backgroundColor = 'green';
      }
      if (tickNo % 20) {
        setTimeout(() => {
          color = colorThief.getColor(canvas);
        }, 500);
      }
      setTimeout(tick, 50);
    }

    detectCollision = () => {
      if (!color) return false;

      const data = ctx.getImageData(frogX, frogY, 50, 50).data;
      let sum = 0;
      for (let i=0; i<data.length; i+=4) {
        const rDiff = data[i] - color[0];
        const gDiff = data[i+1] - color[1];
        const bDiff = data[i+2] - color[2];
        sum += Math.sqrt(rDiff**2 + gDiff**2 + bDiff**2);
      }
      return sum > 100000;
    }

    drawFrame = () => {
      ctx.drawImage(video, 0, 0, w, h);
    }

    drawGame = () => {
      if (gameHasChanged) {
        gctx.clearRect(0,0,w,h);
        gctx.drawImage(frog, frogX, frogY, 50, 50)
        gameHasChanged = false;
      }
    }

  </script>
</body>
</html>
