<html>
<head>
<style>
#swatch {
  width: 40px;
  height: 40px;
}

#gameContainer canvas {
  position: absolute;
  left: 0;
}

.gameStats {
  color: lime;
  font-size: 600%;
}

#gameDifficulty {
  position: absolute;
  left: 5%;
  top: 5%;
}

#gameScore {
  position: absolute;
  right: 5%;
  top: 5%;
}

</style>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
</head>
<body>
  <script src="assets/js/color-thief.min.js"></script>
  <script src="assets/js/resemble.js"></script>
  <video autoplay="true" id="videoElement" src="assets/vid/test.mov" width="600" style="display:none" loop></video>
  <div id="gameContainer">
    <canvas width="600" id="canvas" height="375"></canvas>
    <canvas width="600" id="game" height="375"></canvas>
  </div>
  <div id="gameOverlay">
    <div id="gameInfo">
      <div id="gameDifficulty" class="gameStats">0.0</div>
      <div id="gameScore" class="gameStats">10000</div>
    </div>
  </div>
  <img src="assets/img/frog.png" id="frog" width="50" style="display:none">
  <script>
    const video = document.getElementById('videoElement'),
        canvas = document.getElementById('canvas'),
        game = document.getElementById('game'),
        frog = document.getElementById('frog'),
        body = document.querySelector('body'),
        ctx = canvas.getContext('2d'),
        gctx = game.getContext('2d'),
        colorThief = new ColorThief();

    let w = window.innerWidth, h = window.innerHeight;
    let frogX = w/2 - 25, frogY = h - 50;
    let color;
    let gameHasChanged = true;
    let tickNo = 0;

    document.onkeydown = (e) => {
      if (e.keyCode == '38') frogY-=2;
      else if (e.keyCode == '40') frogY+=2;
      else if (e.keyCode == '37') frogX-=2;
      else if (e.keyCode == '39') frogX+=2;
      gameHasChanged = true;
      e.preventDefault();
    };

    resize = () => {
      w = window.innerWidth;
      h = window.innerHeight;
      game.height = h;
      canvas.height = h;
      game.width = w;
      canvas.width = w;
    }

    init = () => {
      resize();
      tick();
    }

    tick = () => {
      tickNo++;
      drawFrame();
      body.style.backgroundColor = detectCollision() ? 'red' : 'green';

      if (gameHasChanged) drawGame();
      if (tickNo % 20) updateSwatch();

      setTimeout(tick, 50);
    }

    updateSwatch = () => {
      if (!canvas) return;
      color = colorThief.getColor(canvas);
      gctx.fillStyle = '#' + color[0].toString(16) + color[1].toString(16) + color[2].toString(16);
    }

    detectCollision = () => {
      if (!color) return false;

      const data = ctx.getImageData(frogX, frogY, 50, 50).data;
      let sum = 0;
      for (let i=0; i<data.length; i+=8) {
        const rDiff = data[i] - color[0];
        const gDiff = data[i+1] - color[1];
        const bDiff = data[i+2] - color[2];
        sum += Math.sqrt(rDiff**2 + gDiff**2 + bDiff**2);
      }
      return sum > 100000;
    }

    drawFrame = () => {
      ctx.drawImage(video, 0, 0, w, h);
    }

    drawGame = () => {
      gctx.clearRect(0,0,w,h);
      gctx.drawImage(frog, frogX, frogY, 40, 40)
      gctx.fillRect(0,0,40,40);

      gctx.fillStyle="lime";
      // start line
      gctx.fillRect(0, h * 7 / 8, w, 10);
      // stop line
      gctx.fillRect(0, h * 2 / 5, w, 10);

      gameHasChanged = false;
    }

    window.addEventListener('resize', resize);
    video.addEventListener('play', init, false);
  </script>
</body>
</html>
