<html>
<head>
</head>
<body>
  <video style="display: none" id="videoElement" autoplay="true"></video>
  <canvas width="600" id="canvas" height="375"></canvas>
  <img src="assets/img/frog.png" id="frog" width="50" style="display:none">
  <div id="lose"
  style="background-color: red; font-size: 100px">
    YOU LOSE
  </div>
  <script>
  /**
   * First, play the video in the <video> element
   */
    const video = document.getElementById("videoElement"),
        canvas = document.getElementById('canvas'),
        frog = document.getElementById('frog'),
        lose = document.getElementById('lose'),
        ctx = canvas.getContext('2d'),
        n = navigator,
        w = canvas.width, h = canvas.height;

    let frogX = 0, frogY = 0;

    n.getUserMedia = n.getUserMedia || n.webkitGetUserMedia || n.mozGetUserMedia || n.msGetUserMedia || n.oGetUserMedia;

    n.getUserMedia && n.getUserMedia(
      {video: true},
      s => video.src = window.URL.createObjectURL(s),
      () => {}
    );

    document.onkeydown = (e) => {
      if (e.keyCode == '38') frogY--;
      else if (e.keyCode == '40') frogY++;
      else if (e.keyCode == '37') frogX--;
      else if (e.keyCode == '39') frogX++;
    };

    video.addEventListener('play', () => {
      if (video.currentTime < 5) video.currentTime = 20;
      drawFrame();
    }, false)

    drawFrame = () => {
      ctx.drawImage(video, 0, 0, w, h);
      ctx.drawImage(frog, frogX, frogY, 50, 50)
      lose.style.visibility = detectCollision() ? "visible" : "hidden";
      setTimeout(drawFrame, 10);
    }

    detectCollision = () => {
      const data = ctx.getImageData(frogX, frogY, 50, 50).data;
      let darkest = 0;
      for (let i=0; i<data.length; i+=4) {
        const sum = data[i] + data[i+1] + data[i+2];
        darkest = darkest > sum ? darkest : sum;
      }
      console.log(darkest);
      return darkest > 500;
    }

  </script>
</body>
</html>
